# Graceful Shutdown

### 비정상 종료로 인한 문제점

- 데이터 손실 및 손상
:   진행 중인 데이터가 저장되지 않아 데이터 손상이나 불일치가 발생할 수 있다. 이는 엔드포인트 손상 , 파일 시스템 손상 , 데이터베이스의 신뢰할 수 없는 파티션  등으로 나타날 수 있다.

- 자원 누수
: 열린 파일 핸들, 데이터베이스 연결 및 기타 자원이 제대로 해제되지 않아 자원 고갈 또는 고아 연결(orphaned connections)로 이어질 수 있다

- 서비스 가용성 저하
: 분산 시스템에서 갑작스러운 종료는 요청 실패, 서비스 비가용성 및 사용자 경험 방해로 이어질 수 있다. 클라이언트는 "503 Service Unavailable" 또는 연결 오류를 경험할 수 있다.

### Graceful Shutdown 구현 단계

#### 종료 신호 감지 (SIGTERM, SIGINT)
- 애플리케이션은 시스템 수준의 종료 신호(termination signals)를 감지하고 올바르게 처리하도록 설계되어저야함.
- `SIGTERM`에 응답하여 정상 종료 시퀀스를 시작할 것을 기대한다. 만약 애플리케이션이 주어진 시간 내에 그렇게 하지 못하면, 계약이 파기되고 시스템은 시스템 안정성을 유지하기 위해 `SIGKILL`을 사용하여 종료를 강제한다. 이는 애플리케이션이 단순히 신호를 감지하는 것을 넘어, 적시에 예측 가능한 방식으로 신호에 대응해야 함을 의미한다. 따라서 개발자는 프로덕션 시스템에서 SIGTERM 처리를 필수 요구 사항으로 간주해야 하며, 애플리케이션이 유예 기간 내에 응답하지 않으면 운영 체제가 종료를 강제할 것임을 이해해야 한다.
  - aws ecs 컨테이너 작업이 중지되면 `SIGTERM`과 `SIGKILL` 신호 전송 사이에는 30초의 지연 시간

#### 신규 요청 중단
- 종료 신호를 수신하면 서비스는 즉시 새로운 인바운드 트래픽 또는 요청 수신을 중단해야 한다. 이는 종종 로드 밸런서에서 등록을 해제하거나 네트워크 리스너를 닫는 것을 포함한다.

#### 진행 중인 작업 완료
- 애플리케이션은 진행 중인 모든 요청, 트랜잭션 및 백그라운드 작업이 정상적으로 완료되도록 허용해야 한다. 여기에는 데이터베이스 트랜잭션, 큐에서 메시지 처리, 장기 실행 백그라운드 작업이 포함된다.

#### 자원 해제 및 정리
- 애플리케이션이 종료되기 전에 모든 중요한 자원이 제대로 해제되어야 한다. 여기에는 다음이 포함된다:
  - 데이터베이스 연결 및 연결 풀 닫기. 
  - 열린 파일 핸들 및 네트워크 소켓 닫기. 
  - 로그 및 메트릭 플러시. 
  - 임시 파일 또는 상태 정리

