# buffer - string 형변환시 이슈사항

### Buffer

서버에서 TCP 스트림을 처리하고 파일 시스템에서 읽기-쓰기 연산을 수행할 때는 순수한 바이너리 데이터를 처리하는 것이 필요할때가 있다.     
이러한 요구를 충족시키기 위해 Node.js는 버퍼 클래스를 지원해주는데 Buffer 클래스는 원시 바이너리 데이터을 저장하는 데 사용되는 길이가 고정된 메모리 블록을 나타낸다.  
일반적으로 버퍼는 메모리 내 특정 메모리 위치를 나타내며 배열과 다르게 버퍼는 이진 데이터만 처리하며 크기를 조정할 수 없다. (버퍼의 각 정수는 바이트를 나타냄.)

버퍼 객체를 다루면서 string으로 인코딩하거나 다시 디코딩하는 방법을 사용하는데 이때 사용하는 메서드는 다음과 같다.
- Buffer.from() - 문자열을 버퍼로 변환
- toString() - 버퍼를 문자열로 변환
```ts
  const text = 'test';
  
  const buffer = Buffer.from(text);
  
  const result = text.toString();

  console.log(result === text)
```

### UTF-8 형변환 이슈
여기서 알아야될 부분은 인코딩 및 디코딩의 변환 방식은 기본값으로 "UTF-8"을 사용한다는 것이다.    
UTF-8은 유니코드 문자를 이진 데이터로 변환하기 위한, 가변 길이 문자 인코딩 방식이다.     
UTF-8로 텍스트를 인코딩할 때 특정 상황에서는 대체 문자 U+FFFD(�)가 인코딩된 출력에 삽입될 수 있는데 보통 사례로는 다음과 같을수 있다.
- 잘못된 바이트 시퀀스 
- 유니코드 범위 밖의 코드 포인트

이렇게 되면 에러가 발생하거나 데이터 손실이 된 채로 인코딩되어져 인코딩된 문자열은 다시 디코딩할 때 원래의 문자열로 복원되지 않을 수 있다.  
실제 필자도 암호화되어진 buffer 객체를 다시 string으로 인코딩 후 디코딩했을때 정상적으로 복원되지 않는 이슈가 있었다.    
그래서 해당 이슈들을 확인해 보니 UTF-8 형식은 바이너리-텍스트 인코딩인 헥스 및 base64와 달리 텍스트-바이너리 인코딩이며    
즉, 문자열에서 바이너리로 변환하는 것은 항상 성공하지만 바이너리에서 문자열로 변환하는 것은 항상 성공하지 않는다는 것이다.

이 이슈를 확인후 base64 형식으로 인코딩 및 디코딩 하는 방식으로 변경후 정상적으로 변경되는 것을 확인했다.
```ts

    const text = 'test';
    
    const buffer = Buffer.from(text, 'base64');
    
    const result = text.toString('base64');
    
    console.log(result === text)
```

