## Aws OpenSearch Service 문서 딥다이빙

### JVMMemoryPressure
- OpenSearch Service 클러스터에서 모든 데이터 노드에 사용되는 Java 힙의 백분율
- 높은 JVMMemoryPressure 원인
  - 리소스 양에 비례하여 클러스터에 있는 데이터 양
  - 클러스터 쿼리 로드

> 참고: Elasticsearch 7.x / OpenSearch 1.x 이하에서는 CMS(Concurrent Mark Sweep) GC를 사용하지만, OpenSearch 2.x부터는 기본 GC가 **G1GC**로 변경되었습니다. 아래 임계값별 동작은 동일하게 적용되지만, GC 수집 방식에 차이가 있습니다.

#### JVMMemoryPressure 비율에 따른 상황

| 비율 | 상황 |
|---|---|
| **75%** | GC(가비지 수집)가 본격적으로 시작됩니다. CMS의 경우 Concurrent Mark Sweep, G1GC의 경우 Mixed GC가 트리거됩니다. 다른 프로세스와 함께 실행되며 일시 정지 및 중단을 최소한으로 유지합니다. |
| **75% 초과** | GC가 메모리를 충분하게 회수하지 못하면 JVM은 추가 메모리 확보를 시도합니다. 프로세스 속도를 낮추거나 중지하여 OutOfMemoryError(OOM)를 방지합니다. |
| **92% 이상** | Old GC가 트리거됩니다. 이 단계에서는 Stop-the-World 방식으로 전체 힙을 정리하므로 **클러스터 응답 지연이 크게 증가**합니다. |
| **지속적 증가** | JVM이 메모리 할당을 시도하는 프로세스를 강제 중지합니다. 중요 프로세스가 중지되면 **노드 장애**로 이어질 수 있습니다. |

- JVMMemoryPressure는 **80% 미만**으로 유지하는 것이 권장됩니다.
- CPU 사용량 역시 **80% 미만**으로 유지해야 합니다. CPU 사용량이 높으면 GC 스레드가 충분한 CPU를 확보하지 못해 메모리 회수가 지연되고, 결과적으로 JVMMemoryPressure가 더 빠르게 상승합니다.
- 참고: OpenSearch Service에서 여러 가비지 수집 지표를 Amazon CloudWatch에 게시합니다. 이 지표는 JVM 메모리 사용량을 모니터링하는 데 도움이 됩니다.

#### CloudWatch 알람 설정 가이드

| 지표 | 임계값 | 기간 | 알람 수준 |
|---|---|---|---|
| JVMMemoryPressure | >= 75% | 5분 | Warning |
| JVMMemoryPressure | >= 85% | 5분 | Critical |
| JVMMemoryPressure | >= 92% | 1분 | Emergency |
| OldGenJVMMemoryPressure | >= 80% | 5분 | Critical |

#### JVMMemoryPressure를 낮추기 위한 해결 방법

- 와일드카드 쿼리와 같은 범위가 넓은 쿼리를 실행하지 않습니다.
- 동시에 많은 수의 요청을 보내지 않습니다.
- 필요한 샤드 수를 확보했는지 확인합니다. 인덱싱 전략에 대한 자세한 내용은 [샤드 수 선택](https://docs.aws.amazon.com/ko_kr/opensearch-service/latest/developerguide/bp-sharding.html)을 참조하세요.
- 샤드가 노드 간에 균등하게 분산되었는지 확인합니다.
- 텍스트 필드에서 집계 작업을 수행하지 않습니다. 이를 통해 필드 데이터의 증가를 방지할 수 있습니다. 필드 데이터가 많을수록 힙 공간을 더 많이 차지하게 됩니다. `GET _cluster/stats` API 작업을 사용하여 필드 데이터를 확인합니다. 자세한 정보는 Elasticsearch 문서에서 fielddata를 참조하세요.
- 텍스트 필드를 집계해야 하는 경우 매핑 유형을 `keyword`로 변경합니다.
- JVM 메모리 압박이 너무 높은 경우 아래 API를 사용하여 필드 데이터 캐시를 지웁니다.
  - `POST /index_name/_cache/clear` (인덱스 수준 캐시)
  - `POST /_cache/clear` (클러스터 수준 캐시)
  - 주의: 캐시를 지우면 진행 중인 쿼리가 중단될 수 있습니다.

#### 레퍼런스
- [내 OpenSearch Service 노드가 충돌하는 이유는 무엇인가요?](https://repost.aws/ko/knowledge-center/opensearch-node-crash)

### 할당량

주요 할당량 요약:

| 항목 | 제한 |
|---|---|
| 도메인당 최대 데이터 노드 수 | 80 |
| 도메인당 최대 웜 노드 수 | 150 |
| 도메인당 최대 전용 마스터 노드 수 | 5 |
| 노드당 최대 EBS 볼륨 크기 | 인스턴스 유형에 따라 다름 (최대 24TB) |
| HTTP 요청 페이로드 최대 크기 | 10MB (`_bulk` 포함) |
| 도메인당 최대 샤드 수 | 데이터 노드당 1,000개 (기본값) |
| 인스턴스당 최대 인덱스 수 | 제한 없음 (샤드 수로 제한) |

- 할당량은 인스턴스 유형과 OpenSearch 버전에 따라 다를 수 있으므로, 공식 문서에서 정확한 수치를 확인해야 합니다.

#### 레퍼런스
- [OpenSearch Service 할당량](https://docs.aws.amazon.com/ko_kr/opensearch-service/latest/developerguide/limits.html#ebsresource)

### 샤드 전략

#### 핵심 가이드라인

- **샤드 크기**: 샤드당 **10~50GB**가 권장됩니다. 검색 위주의 워크로드는 10~30GB, 로그/시계열 데이터는 30~50GB가 적절합니다.
- **샤드 수 계산 공식**: `샤드 수 = 인덱스 크기(GB) / 샤드 크기(GB)`
- **노드당 최대 샤드 수**: 힙 메모리 1GB당 약 **25개** 샤드가 권장됩니다.
  - 예: 힙 4GB 노드 → 최대 약 100개 샤드
- **Primary 샤드 수는 인덱스 생성 후 변경 불가**합니다. `_reindex` API를 사용해 새 인덱스로 마이그레이션해야 합니다.
- **Replica 샤드**: 가용성을 위해 최소 1개의 복제본이 권장됩니다. 읽기 부하가 높은 경우 복제본을 늘려 분산할 수 있습니다.

#### 샤드 과다(Over-Sharding) 문제

샤드가 너무 많으면:
- 각 샤드는 별도의 Lucene 인덱스이므로 파일 핸들, 메모리, CPU를 소비합니다.
- 클러스터 상태(Cluster State)가 커져 마스터 노드 부하가 증가합니다.
- 검색 시 모든 샤드에 쿼리를 보내야 하므로 Fan-out 오버헤드가 발생합니다.

#### 레퍼런스
- [Elasticsearch 인덱스와 샤드](https://esbook.kimjmin.net/03-cluster/3.2-index-and-shards)
- [OpenSearch Service 샤딩 전략](https://docs.aws.amazon.com/ko_kr/opensearch-service/latest/developerguide/bp.html#bp-sharding-strategy)
- [샤드 수 선택 가이드](https://docs.aws.amazon.com/ko_kr/opensearch-service/latest/developerguide/bp-sharding.html)


### 동의어 사전 패키지 적용

#### 초기 등록 프로세스

1. S3에 동의어 사전 파일 업로드
2. OpenSearch Service 패키지 등록
3. OpenSearch Service 도메인에 패키지 연결

- Amazon S3에 새 버전의 패키지를 업로드해도 OpenSearch Service에 패키지가 **자동으로 업데이트되지 않습니다**.
- OpenSearch Service는 파일의 자체 복사본을 저장하므로 새 버전을 S3에 업로드하는 경우 수동으로 업데이트해야 합니다.

#### 업데이트 프로세스

1. S3에 새 버전의 동의어 사전 파일 업로드
2. OpenSearch Service 패키지 업데이트
3. OpenSearch Service 도메인에 패키지 업데이트 적용
4. 도메인에서 OpenSearch 또는 Elasticsearch 7.8 이상을 실행하고 `updateable` 필드가 `true`로 설정된 **search analyzer만을 사용하는 경우** 추가 작업은 필요하지 않습니다.
   OpenSearch Service는 [Refresh search analyzer](https://docs.opensearch.org/latest/im-plugin/refresh-analyzer/) API를 사용하여 인덱스를 자동으로 업데이트합니다.

> 주의: 패키지 업데이트/연결 시 **Blue/Green 배포가 트리거**될 수 있습니다. 배포 중에는 클러스터에 추가 노드가 생성되므로, 충분한 리소스 여유가 있는지 확인하세요.

#### updateable analyzer 설정 예시

```json
PUT /my-index
{
  "settings": {
    "index": {
      "analysis": {
        "analyzer": {
          "my_synonym_analyzer": {
            "type": "custom",
            "tokenizer": "standard",
            "filter": ["lowercase", "my_synonym_filter"]
          }
        },
        "filter": {
          "my_synonym_filter": {
            "type": "synonym",
            "synonyms_path": "analyzers/F123456789",
            "updateable": true
          }
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "description": {
        "type": "text",
        "search_analyzer": "my_synonym_analyzer"
      }
    }
  }
}
```

- `updateable: true`는 **search_analyzer에서만** 사용 가능합니다. index_analyzer에 적용하면 리인덱싱 없이는 반영되지 않습니다.
- `synonyms_path`의 값은 패키지를 도메인에 연결한 후 확인할 수 있는 패키지 ID입니다.

#### 동의어 사전 파일 포맷

Solr 포맷 (가장 일반적):
```
# 단방향 동의어 (왼쪽을 오른쪽으로 확장)
아이폰, 아이팟 => apple
노트북 => laptop, notebook

# 양방향 동의어 (서로 동의어로 인식)
삼성, 갤럭시, samsung
```

![동의어 사전 아키텍처](./opensearch-synonym--architecture.png)

#### 레퍼런스
- [OpenSearch Service 사용자 지정 패키지](https://docs.aws.amazon.com/ko_kr/opensearch-service/latest/developerguide/custom-packages.html)
- [Amazon ES 동의어 파일 자동 업데이트](https://aws.amazon.com/blogs/big-data/automate-amazon-es-synonym-file-updates/)
